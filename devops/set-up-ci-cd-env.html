<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>用 Docker-Nginx-Jenkins-Gitlab 搭建 CI/CD 环境 | Dreampasssser's Blog</title>
    <meta name="description" content="A VitePress site, markdown中的数学公式, LaTeX, nodejs版本管理">
    <link rel="preload stylesheet" href="/assets/style.39cf6be6.css" as="style">
    <link rel="modulepreload" href="/assets/app.252ff558.js">
    <link rel="modulepreload" href="/assets/devops_set-up-ci-cd-env.md.c9f4f0f7.lean.js">
    
    <meta name="theme-color" content="#3c8772">
  <meta name="keywords" content="LaTeX In Markdown, nodejs版本管理">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-230354d0><!--[--><!--]--><!--[--><span tabindex="-1" data-v-9cddc253></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-9cddc253> Skip to content </a><!--]--><!----><header class="VPNav no-sidebar" data-v-230354d0 data-v-6d47a87b><div class="VPNavBar" data-v-6d47a87b data-v-80002dd1><div class="container" data-v-80002dd1><div class="title" data-v-80002dd1><div class="VPNavBarTitle" data-v-80002dd1 data-v-113650a1><a class="title" href="/" data-v-113650a1><!--[--><!--]--><!----><!--[-->Dreampasssser&#39;s Blog<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-80002dd1><div class="curtain" data-v-80002dd1></div><!--[--><!--]--><!----><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-80002dd1 data-v-9053ec20><span id="main-nav-aria-label" class="visually-hidden" data-v-9053ec20>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/latex/basics" data-v-9053ec20 data-v-ffdc1a90 data-v-b03262b4><!--[-->LaTeX In Markdown<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/others/nodejs-version-management" data-v-9053ec20 data-v-ffdc1a90 data-v-b03262b4><!--[-->Others<!--]--><!----></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-80002dd1 data-v-e73dcb39><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e73dcb39 data-v-5f3153a9 data-v-15153f05><span class="check" data-v-15153f05><span class="icon" data-v-15153f05><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-5f3153a9><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-5f3153a9><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-80002dd1 data-v-a3409b17 data-v-be9db6d2><!--[--><a class="VPSocialLink" href="https://github.com/dreampasssser/dreampasssser.github.io" target="_blank" rel="noopener" data-v-be9db6d2 data-v-1bc19b70><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-80002dd1 data-v-b2c7c6ac data-v-972954b3><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-972954b3><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-972954b3><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-972954b3><div class="VPMenu" data-v-972954b3 data-v-d9120cbf><!----><!--[--><!--[--><!----><div class="group" data-v-b2c7c6ac><div class="item appearance" data-v-b2c7c6ac><p class="label" data-v-b2c7c6ac>Appearance</p><div class="appearance-action" data-v-b2c7c6ac><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-b2c7c6ac data-v-5f3153a9 data-v-15153f05><span class="check" data-v-15153f05><span class="icon" data-v-15153f05><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-5f3153a9><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-5f3153a9><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-b2c7c6ac><div class="item social-links" data-v-b2c7c6ac><div class="VPSocialLinks social-links-list" data-v-b2c7c6ac data-v-be9db6d2><!--[--><a class="VPSocialLink" href="https://github.com/dreampasssser/dreampasssser.github.io" target="_blank" rel="noopener" data-v-be9db6d2 data-v-1bc19b70><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-80002dd1 data-v-9accada2><span class="container" data-v-9accada2><span class="top" data-v-9accada2></span><span class="middle" data-v-9accada2></span><span class="bottom" data-v-9accada2></span></span></button></div></div></div><!----></header><!----><!----><div class="VPContent" id="VPContent" data-v-230354d0 data-v-d879f97d><div class="VPDoc has-aside" data-v-d879f97d data-v-88a8e94b><div class="container" data-v-88a8e94b><div class="aside" data-v-88a8e94b><div class="aside-curtain" data-v-88a8e94b></div><div class="aside-container" data-v-88a8e94b><div class="aside-content" data-v-88a8e94b><div class="VPDocAside" data-v-88a8e94b data-v-06f95eb7><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-06f95eb7 data-v-08145e93><div class="content" data-v-08145e93><div class="outline-marker" data-v-08145e93></div><div class="outline-title" data-v-08145e93>本页目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-08145e93><span class="visually-hidden" id="doc-outline-aria-label" data-v-08145e93> Table of Contents for current page </span><ul class="root" data-v-08145e93 data-v-cc9343c6><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-06f95eb7></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-88a8e94b><div class="content-container" data-v-88a8e94b><!--[--><!--]--><main class="main" data-v-88a8e94b><div style="position:relative;" class="vp-doc _devops_set-up-ci-cd-env" data-v-88a8e94b><div><h1 id="用-docker-nginx-jenkins-gitlab-搭建-ci-cd-环境" tabindex="-1">用 Docker-Nginx-Jenkins-GitLab 搭建 CI/CD 环境 <a class="header-anchor" href="#用-docker-nginx-jenkins-gitlab-搭建-ci-cd-环境" aria-hidden="true">#</a></h1><ul><li>Docker 提供容器环境</li><li>docker-compose 定义和运行由多个容器组成的应用</li><li>Jenkins 持续集成交付</li><li>GitLab 代码仓库</li><li>Harbor 私有镜像仓库</li><li>Verdaccio 私有 npm 仓库</li></ul><h2 id="在-ubuntu-上安装-docker-engine" tabindex="-1">在 Ubuntu 上安装 Docker Engine <a class="header-anchor" href="#在-ubuntu-上安装-docker-engine" aria-hidden="true">#</a></h2><h3 id="准备工作" tabindex="-1">准备工作 <a class="header-anchor" href="#准备工作" aria-hidden="true">#</a></h3><h4 id="系统要求" tabindex="-1">系统要求 <a class="header-anchor" href="#系统要求" aria-hidden="true">#</a></h4><ul><li>Ubuntu Kinetic 22.10</li><li>Ubuntu Jammy 22.04 (LTS)</li><li>Ubuntu Focal 20.04 (LTS)</li><li>Ubuntu Bionic 18.04 (LTS)</li></ul><h4 id="卸载旧版本" tabindex="-1">卸载旧版本 <a class="header-anchor" href="#卸载旧版本" aria-hidden="true">#</a></h4><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">remove</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-engine</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker.io</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">containerd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">runc</span></span>
<span class="line"></span></code></pre></div><h3 id="安装方法" tabindex="-1">安装方法 <a class="header-anchor" href="#安装方法" aria-hidden="true">#</a></h3><h4 id="使用-apt-安装" tabindex="-1">使用 APT 安装 <a class="header-anchor" href="#使用-apt-安装" aria-hidden="true">#</a></h4><ul><li><p>apt 升级，并添加相关软件包</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">apt-transport-https</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">ca-certificates</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">gnupg</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">lsb-release</span></span>
<span class="line"></span></code></pre></div></li><li><p>为了确认所下载软件包的合法性，需要添加软件源的 <code>GPG</code> 密钥（鉴于国内网络问题，改用国内源）</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 权限不够时先执行这个，够则不执行</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-m</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0755</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/keyrings</span></span>
<span class="line"></span></code></pre></div><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-fsSL</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu/gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dearmor</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/keyrings/docker.gpg</span></span>
<span class="line"></span></code></pre></div></li><li><p>向 <code>sources.list</code> 中添加 Docker 软件源</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> \</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deb [arch=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">dpkg</span><span style="color:#C3E88D;"> --print-architecture</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;"> signed-by=/etc/apt/keyrings/docker.gpg] https://mirrors.ustc.edu.cn/docker-ce/linux/ubuntu </span><span style="color:#A6ACCD;">\</span></span>
<span class="line"><span style="color:#C3E88D;">  </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">lsb_release</span><span style="color:#C3E88D;"> -cs</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;"> stable</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tee</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/sources.list.d/docker.list</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/dev/null</span></span>
<span class="line"></span></code></pre></div></li><li><p>更新 apt 软件包缓存，并安装 <code>docker-ce</code></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"></span></code></pre></div><p>默认的 umask 可能配置错误，导致无法检测到存储库公钥文件。在更新包索引之前，尝试授予 Docker 公钥文件的读权限：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a+r</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/apt/keyrings/docker.gpg</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"></span></code></pre></div><p>安装 <code>docker-ce</code></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce-cli</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">containerd.io</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-buildx-plugin</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-compose-plugin</span></span>
<span class="line"></span></code></pre></div></li></ul><h4 id="使用脚本安装" tabindex="-1">使用脚本安装 <a class="header-anchor" href="#使用脚本安装" aria-hidden="true">#</a></h4><blockquote><p><code>--mirror</code> 选项，指定源进行安装</p><p><code>--dry-run</code> 选项，了解脚本在被调用时将运行哪些步骤</p></blockquote><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-fsSL</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get.docker.com</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get-docker.sh</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get-docker.sh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--dry-run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--mirror</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Aliyun</span></span>
<span class="line"></span></code></pre></div><h3 id="启动-docker" tabindex="-1">启动 Docker <a class="header-anchor" href="#启动-docker" aria-hidden="true">#</a></h3><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">enable</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"></span></code></pre></div><h3 id="建立-docker-用户组" tabindex="-1">建立 Docker 用户组 <a class="header-anchor" href="#建立-docker-用户组" aria-hidden="true">#</a></h3><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 建立 docker 组</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">groupadd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 将当前用户加入 docker 组</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">usermod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-aG</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> $USER</span></span>
<span class="line"></span></code></pre></div><p>退出当前终端并重新登录，进行如下测试。</p><h3 id="测试-docker-安装是否正确" tabindex="-1">测试 Docker 安装是否正确 <a class="header-anchor" href="#测试-docker-安装是否正确" aria-hidden="true">#</a></h3><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">hello-world</span></span>
<span class="line"></span></code></pre></div><h3 id="配置镜像加速" tabindex="-1">配置镜像加速 <a class="header-anchor" href="#配置镜像加速" aria-hidden="true">#</a></h3><p>由于镜像服务可能出现宕机，所以建议配置多个镜像。<code>/etc/docker/daemon.json</code> （如果没有就新建）中写入如下内容：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">  &quot;</span><span style="color:#C3E88D;">registry-mirrors</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">[</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#C3E88D;">https://dockerhub.azk8s.cn</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#C3E88D;">https://reg-mirror.qiniu.com</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#C3E88D;">https://hub-mirror.c.163.com</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#89DDFF;">    &quot;</span><span style="color:#C3E88D;">https://mirror.baidubce.com</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><p>注意，一定要保证该文件符合 json 规范，否则 Docker 将不能启动。</p></blockquote><p>之后重新启动服务：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">daemon-reload</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">restart</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"></span></code></pre></div><h2 id="安装-nginx-jenkins-gitlab-镜像" tabindex="-1">安装 Nginx，Jenkins，GitLab 镜像 <a class="header-anchor" href="#安装-nginx-jenkins-gitlab-镜像" aria-hidden="true">#</a></h2><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pull</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pull</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jenkins/jenkins:lts</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pull</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gitlab/gitlab-ce</span></span>
<span class="line"></span></code></pre></div><p>为了配合 compose，以及方便管理以上三个镜像的文件，统一把他们建立在 <code>$HOME</code> 的文件夹下，<code>$HOME</code> 就是与你用户名同名的那个文件夹 <code>/home/user</code>，<code>user</code> 为你的用户名。（这里暂且先在 <code>$HOME</code> 下，后面会再尝试放在公共目录下，到时再更新）</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker/{jenkins/jenkins_home,nginx,gitlab,compose,webserver}</span></span>
<span class="line"></span></code></pre></div><p>以上命令，通过 <code>mkdir</code> ， 建立目录如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">home</span></span>
<span class="line"><span style="color:#A6ACCD;">  user</span></span>
<span class="line"><span style="color:#A6ACCD;">  + docker</span></span>
<span class="line"><span style="color:#A6ACCD;">    + jenkins</span></span>
<span class="line"><span style="color:#A6ACCD;">      + jenkins_home</span></span>
<span class="line"><span style="color:#A6ACCD;">    + nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    + gitlab     // gitlab 文件存放</span></span>
<span class="line"><span style="color:#A6ACCD;">    + compose    // 管理docker-compose.yml 后续会提到</span></span>
<span class="line"><span style="color:#A6ACCD;">    + webserver  // 用于项目发布的地方</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>compose</code> 文件夹下新建 <code>docker-compose.yml</code> ，内容如下：</p><div class="language-yml"><button title="Copy Code" class="copy"></button><span class="lang">yml</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">version: &#39;1&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">services: # 集合</span></span>
<span class="line"><span style="color:#A6ACCD;">  docker_jenkins:</span></span>
<span class="line"><span style="color:#A6ACCD;">    user: root # 为了避免一些权限问题 在这使用了root</span></span>
<span class="line"><span style="color:#A6ACCD;">    restart: always # 重启方式</span></span>
<span class="line"><span style="color:#A6ACCD;">    image: jenkins/jenkins:lts # 指定服务所使用的镜像 在这里我选择了 LTS (长期支持)</span></span>
<span class="line"><span style="color:#A6ACCD;">    container_name: jenkins # 容器名称</span></span>
<span class="line"><span style="color:#A6ACCD;">    ports: # 对外暴露的端口定义    外部端口:内部端口</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 8081:8080</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 50000:50000</span></span>
<span class="line"><span style="color:#A6ACCD;">    volumes: # 卷挂载路径   系统本地目录:容器内目录</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/jenkins/jenkins_home/:/var/jenkins_home # 这是我们一开始创建的目录挂载到容器内的jenkins_home目录</span></span>
<span class="line"><span style="color:#A6ACCD;">      - /var/run/docker.sock:/var/run/docker.sock</span></span>
<span class="line"><span style="color:#A6ACCD;">      - /usr/bin/docker:/usr/bin/docker # 这是为了我们可以在容器内使用docker命令</span></span>
<span class="line"><span style="color:#A6ACCD;">      - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose</span></span>
<span class="line"><span style="color:#A6ACCD;">  docker_nginx:</span></span>
<span class="line"><span style="color:#A6ACCD;">    restart: always</span></span>
<span class="line"><span style="color:#A6ACCD;">    image: nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    container_name: nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">    ports: # 有几组端口号（433不算），就可以部署几组静态页面，也就是编译好的前端项目，这样就可以实现部署多个项目</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 80:80</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 81:81</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 82:82</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 433:433</span></span>
<span class="line"><span style="color:#A6ACCD;">    volumes:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/nginx/conf:/etc/nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/nginx/logs:/var/log/nginx</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/webserver:/usr/share/nginx/html</span></span>
<span class="line"><span style="color:#A6ACCD;">  docker_gitlab:</span></span>
<span class="line"><span style="color:#A6ACCD;">    restart: always</span></span>
<span class="line"><span style="color:#A6ACCD;">    image: gitlab/gitlab-ce</span></span>
<span class="line"><span style="color:#A6ACCD;">    container_name: gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;">    ports:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 10443:443</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 1080:80</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 1022:22</span></span>
<span class="line"><span style="color:#A6ACCD;">    volumes:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/gitlab/config:/etc/gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/gitlab/logs:/var/log/gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;">      - $HOME/docker/gitlab/data:/var/opt/gitlab</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="配置-nginx" tabindex="-1">配置 Nginx <a class="header-anchor" href="#配置-nginx" aria-hidden="true">#</a></h2><p>Nginx 这里有一个坑，如果是全新的环境，没有 Nginx 相关配置的话，直接使用 <code>docker compose up -d</code> 启动容器（即用上面的配置挂载卷启动 Nginx），Nginx 会一直重启，导致我们无法正常访问部署的页面。那么怎么解决呢？</p><p>要给 Nginx 挂载卷，要先有一个配置文件才能挂载，具体做法就是先以不挂载卷的形式正常启动一个 Nginx 容器，然后从中 <code>cp</code> 拷贝一份配置文件，删除这个容器，再重新以挂载卷的形式启动一个新容器。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 以不挂载卷的形式正常启动一个 Nginx 容器</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#C3E88D;">:</span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 从容器拷贝配置文件到本地目录</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-test:/etc/nginx</span><span style="color:#A6ACCD;"> $HOME</span><span style="color:#C3E88D;">/docker/nginx/conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 停止 nginx-test 容器</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-test</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 删除 nginx-test 容器</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx-test</span></span>
<span class="line"></span></code></pre></div><p>到 <code>$HOME/docker/nginx/conf</code> 目录下 <code>ls</code>，会发现如下目录与文件：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">conf.d</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">fastcgi_params</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">mime.types</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">modules</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">nginx.conf</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">scgi_params</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">uwsgi_params</span></span>
<span class="line"></span></code></pre></div><p><code>nginx.conf</code> 中存放着 Nginx 总体的配置，它引用了 <code>mime.types</code> 和 <code>conf.d/*.conf</code> ，而 <code>conf.d</code> 中只有一个默认的 server 配置文件 <code>default.conf</code> 。我们可以在 <code>nginx.conf</code> 中直接修改或添加配置，也可以在 <code>conf.d</code> 目录下创建新的 server 配置，如 <code>vue3-vite-ts.conf</code> ，<code>web2.conf</code> ：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># vue3-vite-ts.conf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">  listen       81;</span></span>
<span class="line"><span style="color:#A6ACCD;">  listen  [::]:81;</span></span>
<span class="line"><span style="color:#A6ACCD;">  server_name  localhost;</span></span>
<span class="line"><span style="color:#A6ACCD;">  location / {</span></span>
<span class="line"><span style="color:#A6ACCD;">     root   /usr/share/nginx/html/vue3-vite-ts;</span></span>
<span class="line"><span style="color:#A6ACCD;">     index  index.html index.htm;</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># web2.conf</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">server {</span></span>
<span class="line"><span style="color:#A6ACCD;">  listen       82;</span></span>
<span class="line"><span style="color:#A6ACCD;">  listen  [::]:82;</span></span>
<span class="line"><span style="color:#A6ACCD;">  server_name  localhost;</span></span>
<span class="line"><span style="color:#A6ACCD;">  location / {</span></span>
<span class="line"><span style="color:#A6ACCD;">    root   /usr/share/nginx/html/web2;</span></span>
<span class="line"><span style="color:#A6ACCD;">    index  index.html index.htm;</span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>此处 listen 监听的端口只是内部端口，即 <code>docker-compose.yml</code> 文件中 <code>ports</code> 下 <code>- 81:81</code> 中，冒号后边的那个，冒号前边的才是给浏览器访问用的。</p><p>至此，Nginx 就配置好了，下面启动服务：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 后台启动所有容器（-d 是后台启动）</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">compose</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-d</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 停止所有容器</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># docker compose stop</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 停止所有容器</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># docker compose restart</span></span>
<span class="line"></span></code></pre></div><p>然后就可以用 <code>ip:80</code> 访问到 Nginx 自带的欢迎页， <code>ip:81</code> 、 <code>ip:82</code> 访问我们自己的项目，在 <code>$HOME/docker/webserver</code> 目录下创建 <code>web2/index.html</code> ，随便写点东西就可以去浏览器用 <code>ip:82</code> 查看了（ip 用你自己的主机 ip 替换），至于 <code>vue3-vite-ts</code> ，我们留着后边用工作流发过来。</p><h2 id="配置-jenkins" tabindex="-1">配置 Jenkins <a class="header-anchor" href="#配置-jenkins" aria-hidden="true">#</a></h2><ul><li><p>解锁 Jenkins</p><p>服务启动之后，就可以用 <strong>主机 ip + 上边配置的端口</strong> 来访问 Jenkins 的页面了，如 <code>http://192.168.119.118:8081/</code>，会出现如下的页面：</p><img src="/assets/jenkins_01.b2c1c826.png"><p>去 <code>$HOME/docker/jenkins/jenkins_home/secrets/initialAdminPassword</code> 中找密码，粘过来即可。</p><p>过程中可能 <code>secrets</code> 文件夹没有权限打开，执行 <code>sudo su</code> 切换到 root 用户，即可打开。</p></li><li><p>安装插件</p><p>安装推荐安装的插件。</p></li><li><p>创建第一个管理员用户</p><p>填写用户信息，然后点击 <strong>保存并完成</strong>。</p></li><li><p>配置 Jenkins URL</p><p>保持默认即可，直接点击 <strong>保存并完成</strong>。</p></li><li><p>Jenkins 已就绪</p><p><strong>开始使用Jenkins</strong>，然后就进入你前边创建的管理员用户登录的页面了。</p></li><li><p>管理插件</p><p>点击 <strong>Manage Jenkins</strong> ----&gt; <strong>Manage Plugins</strong></p><img src="/assets/jenkins_02.90b0ce77.png"><p>点击 <strong>Avaliable plugins</strong>，搜索勾选 <strong>NodeJS</strong> 、<strong>Publish Over SSH</strong> 、<strong>GitLab</strong> 插件，点击 <strong>Install without restart</strong> 直接安装</p><img src="/assets/jenkins_03.643ef2c5.png"><p>安装完成后，回到 <strong>Manage Jenkins</strong> ，<strong>Manage Jenkins</strong> ----&gt; <strong>Global Tool Configuration</strong> ，配置 nodejs</p><img src="/assets/jenkins_04.78b6bcd6.png"><p>找到 <strong>NodeJS</strong> ，<strong>新增 NodeJS</strong> ，选择最新的 LTS 版本，保存</p><img src="/assets/jenkins_05.2821d444.png"><p>回到 <strong>Manage Jenkins</strong> ，<strong>Manage Jenkins</strong> ----&gt; <strong>Configure System</strong> ，在最下边找到 Publish Over SSH 并配置</p><img src="/assets/jenkins_06.a64cfb23.jpg"></li></ul><h2 id="配置-gitlab" tabindex="-1">配置 GitLab <a class="header-anchor" href="#配置-gitlab" aria-hidden="true">#</a></h2><ul><li><p>进入 GitLab</p><p>服务启动之后，就可以用 <strong>主机 ip + 端口号</strong> 来访问 GitLab 的页面了，如 <code>http://192.168.119.118:1080/</code>。</p></li><li><p>使用 root 密码登录</p><p>进入页面后，如果没有重置密码的界面，而直接是登录界面，那就需要去 <code>$HOME/docker/gitlab/config/initial_root_password</code> 找到密码，用户名是 root ，然后登录即可。</p></li></ul><h2 id="jenkins-和-gitlab-关联" tabindex="-1">Jenkins 和 GitLab 关联 <a class="header-anchor" href="#jenkins-和-gitlab-关联" aria-hidden="true">#</a></h2><h3 id="gitlab-中创建个人访问令牌" tabindex="-1">GitLab 中创建个人访问令牌 <a class="header-anchor" href="#gitlab-中创建个人访问令牌" aria-hidden="true">#</a></h3><img src="/assets/gitlab_01.0c6b3259.jpg"><p>创建好之后会出现这个</p><img src="/assets/gitlab_02.8cc3a7cf.png"><p>点击右侧小眼睛可以查看，<strong>将内容复制出来保存好，后边会用</strong>。</p><h3 id="jenkins-中配置任务" tabindex="-1">Jenkins 中配置任务 <a class="header-anchor" href="#jenkins-中配置任务" aria-hidden="true">#</a></h3><p>在 Jenkins 中 <strong>新建任务</strong>，然后进行以下配置。</p><h4 id="配置-源码管理-填写对应的源码库与分支" tabindex="-1">配置 <em>源码管理</em>，填写对应的源码库与分支 <a class="header-anchor" href="#配置-源码管理-填写对应的源码库与分支" aria-hidden="true">#</a></h4><img src="/assets/jenkins_07.d2540d13.png"><p>Credentials 一项点击 <strong>添加</strong>，类型选择 Username with password ，用户名填之前在 GitLab 中创建的 jenkins 用户，密码填对应的密码（这里笔者也用过 SSH Username with private key，但一直没有成功）。</p><img src="/assets/jenkins_08.3ad25f61.png"><h4 id="配置-构建触发器" tabindex="-1">配置 <em>构建触发器</em> <a class="header-anchor" href="#配置-构建触发器" aria-hidden="true">#</a></h4><img src="/assets/jenkins_09.c7ddc879.png"><h4 id="配置-构建环境" tabindex="-1">配置 <em>构建环境</em> <a class="header-anchor" href="#配置-构建环境" aria-hidden="true">#</a></h4><img src="/assets/jenkins_10.cfe46bab.png"><h4 id="配置-build-steps" tabindex="-1">配置 <em>Build Steps</em> <a class="header-anchor" href="#配置-build-steps" aria-hidden="true">#</a></h4><p><strong>增加构建步骤</strong> ----&gt; <strong>执行 shell</strong> ，输入需要执行的命令：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span></span>
<span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span></span>
<span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--registry=https://registry.npmmirror.com</span></span>
<span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-v</span></span>
<span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--frozen-lockfile</span></span>
<span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-rf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist.tar</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-zcvf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist.tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./dist</span></span>
<span class="line"></span></code></pre></div><p><code>--frozen-lockfile</code> 这个参数在服务器 <code>install</code> 不会生成 <code>pnpm-lock.yaml</code>，防止服务器和本地代码冲突</p><p><strong>增加构建步骤</strong> ----&gt; <strong>Send files or execute commands over SSH</strong> 。</p><img src="/assets/jenkins_11.7bc5d9b9.png"><p>Exec command 中的命令为：</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/home/pxk/docker/webserver/vue3-vite-ts</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zxvf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist.tar</span></span>
<span class="line"><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-rf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist/</span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">.</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-rf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist.tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dist</span></span>
<span class="line"></span></code></pre></div><h3 id="gitlab-中配置-webhooks" tabindex="-1">GitLab 中配置 Webhooks <a class="header-anchor" href="#gitlab-中配置-webhooks" aria-hidden="true">#</a></h3><p>在项目的设置中找到 Webhooks ，URL 填写 [配置 <em>构建触发器</em>](#配置 <em>构建触发器</em>) 这里的 GitLab Webhook URL ，Secret 令牌 填写 [GitLab 中创建个人访问令牌](#GitLab 中创建个人访问令牌) 这里保存下的令牌，勾选推送事件，然后最下边 <strong>添加webhook</strong> 。</p><img src="/assets/gitlab_05.8394f323.png"><p>如果遇到下面的问题：</p><img src="/assets/gitlab_03.2e4962e8.png"><p>需要到 <strong>管理员</strong> ----&gt; <strong>网络</strong> ----&gt; <strong>出站请求</strong> 这里，勾选上“允许来自 web hooks 和服务对本地网络的请求”，然后 <strong>保存更改</strong>。</p><img src="/assets/gitlab_04.7dccfc5e.png"><p>这样再回去 <strong>添加Webhook</strong> 就能成功了。</p><p>添加成功之后，在页面最下边会生成一个 Project Hooks ，点击 <strong>测试</strong> ----&gt; <strong>推送事件</strong> 测试一下，这时可能会报一个这样的错误：</p><img src="/assets/gitlab_06.c4b4bf36.jpg"><p>这需要 Jenkins 中改一些安全设置。</p><p>Jenkins ----&gt; 系统管理 ----&gt; 全局安全配置 ----&gt; 授权策略 ----&gt; 匿名用户具有可读权限，确保这个选项 <strong>勾选</strong> 。</p><img src="/assets/jenkins_13.cf9d2276.jpg"><p>Jenkins ----&gt; 系统管理 ----&gt; 系统配置 ----&gt; Gitlab ----&gt; Enable authentication for &#39;/project&#39; end-point ，确保这个选项 <strong>没选</strong> 。</p><img src="/assets/jenkins_14.3c6c9a61.png"><h3 id="jenkins-中构建项目" tabindex="-1">Jenkins 中构建项目 <a class="header-anchor" href="#jenkins-中构建项目" aria-hidden="true">#</a></h3><p>在主页找到要构建的任务名称，点开后边下拉框，点击 <strong>立即构建</strong> ：</p><img src="/assets/jenkins_15.511a6606.png"><p>如果最后发送文件时出现这样的错误（从任务点进去会发现有<strong>构建历史</strong>，每条历史都可以展开下拉框查看<strong>控制台输出</strong>）：</p><img src="/assets/jenkins_12.471aa1a9.png"><p>是因为文件发送到的目录的所有者与执行发送命令的用户不是同一个，或者是后者的权限不够，这就需要修改目录所有权。</p><p>更改文件或目录所有权的方法：</p><ul><li><p>当只需要修改所有者时，<code>chown [-R] 所有者 文件或目录</code> ；</p></li><li><p>当需要同时更改所有者和所属组，<code>chown [-R] 所有者:所属组 文件或目录</code> 。</p></li></ul><p>-R（注意大写）选项表示连同子目录中的所有文件，都更改所有者。</p><p>所以执行以下命令即可（user 与 group 用你自己合适的替换）。</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">chown</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-R</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user:group</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vue3-vite-ts</span></span>
<span class="line"></span></code></pre></div><p>修改后即可发送成功。</p><p>最后出现下面这些就是部署成功了：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">Build step &#39;Send files or execute commands over SSH&#39; changed build result to SUCCESS</span></span>
<span class="line"><span style="color:#A6ACCD;">Finished: SUCCESS</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>恭喜！可以去浏览器 <code>ip:81</code> （ip 用你自己的主机 ip）查看了。</p></div></div></main><!--[--><!--]--><!----><!--[--><!--]--></div></div></div></div></div><footer class="VPFooter" data-v-230354d0 data-v-c403debb><div class="container" data-v-c403debb><!----><p class="copyright" data-v-c403debb>Copyright © 2022-present dreampasssser</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"react_index.md\":\"149955a6\",\"index.md\":\"0d0c69c3\",\"vue_index.md\":\"1d3e9ef1\",\"algorithm_index.md\":\"3defb28b\",\"devops_set-up-ci-cd-env.md\":\"c9f4f0f7\",\"others_nodejs-version-management.md\":\"3a6fc6c1\",\"latex_fonts.md\":\"0032a691\",\"latex_greek-letters.md\":\"00b10e84\",\"latex_standard-function-names.md\":\"2d1eb990\",\"others_todo.md\":\"41c28ec1\",\"latex_basics.md\":\"cc97b005\",\"latex_advanced-usage.md\":\"f4522132\",\"latex_special-symbols.md\":\"008c1b5b\"}")</script>
    <script type="module" async src="/assets/app.252ff558.js"></script>
    
  </body>
</html>